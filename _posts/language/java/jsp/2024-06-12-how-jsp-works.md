---
title: "[Java | JSP]JSP의 동작 과정"
categories: [Language, Java]
tags: [Java, 자바, JSP, Servlet]
image:
  path: /assets/img/posts/language/java/01-java-logo.jpg
  lqip: data:image/webp;base64,UklGRpoAAABXRUJQVlA4WAoAAAAQAAAADwAABwAAQUxQSDIAAAARL0AmbZurmr57yyIiqE8oiG0bejIYEQTgqiDA9vqnsUSI6H+oAERp2HZ65qP/VIAWAFZQOCBCAAAA8AEAnQEqEAAIAAVAfCWkAALp8sF8rgRgAP7o9FDvMCkMde9PK7euH5M1m6VWoDXf2FkP3BqV0ZYbO6NA/VFIAAAA
  alt: Java
---

# JSP의 동작 과정

![the-process-by-which-jsp-is-converted-to-servlet](/assets/img/posts/language/java/jsp/how-jsp-works/the-process-by-which-jsp-is-converted-to-servlet.jpg)

## Servlet 변환

![the-process-by-which-jsp-is-converted-to-servlet(1)](/assets/img/posts/language/java/jsp/how-jsp-works/the-process-by-which-jsp-is-converted-to-servlet(1).jpg)

클라이언트가 JSP 페이지를 요청하면 웹 서버는 이 HTTP 요청을 수신하고 WAS에 요청을 위임한다. 최초 요청인 경우에는 Servlet이 존재하지 않으므로 해당 JSP 파일은 **JSP 엔진(Jasper) 의해 Java 파일로 변환되며 이 파일은 Servlet(`HttpServlet` 클래스를 상속받는 클래스) 역할을 수행**한다. Servlet 엔진(Servlet 컨테이너)은 변환된 Servlet 클래스를 이용하여 Servlet 객체 생성 후 `_jspInit()` 메서드를 통해 초기화하고 `_jspService()` 메서드를 실행해 클라이언트의 요청을 처리한다. `_jspInit()`, `_jspService()` 메서드는 각각 `HttpServlet` 클래스에 정의된 `init()`, `service()` 메서드를 오버라이딩한 메서드다.

> JSP 엔진(JSP 컨테이너)는 JSP 파일을 Servlet 소스로 변환 및 컴파일까지만 담당하는 프로그래밍이며, 변환된 Servlet의 수행은 Servlet 엔진이 담당한다.
{: .prompt-info }

> 개발자는 Servlet 엔진을 설치 한 후 서블릿 엔진에게 자기가 개발한 비즈니스 로직, 즉 클래스 파일과 해당 클래스 파일을 어느 요청에서 실행해야 하는지 알려줘야 한다. 이때 우리는 Servlet 엔진이 이해할 수 있는 형태로 클래스 파일을 작성해야 한다. 구체적으로 Servlet 엔진이 이해할 수 있는 클래스란 `javax.servlet.http.HttpServlet`을 상속받는 서브 클래스를 의미하며, 우리는 `HttpServlet` 클래스를 상속받는 클래스를 작성해 특정 형식에 맞춰 압축해 전달해준다. 이렇게 Servlet 엔진을 이용해 개발자는 서버를 처음부터 구현하지 않고도 각기 다른 비즈니스 로직을 구현하고 배포할 수 있다.
{: .prompt-info }

### 매핑 규칙

- JSP 파일의 이름은 `name_jsp.java`{: .filepath } 형식으로 변환
- JSP 스크립트 요소 중 **스크립트릿(Scriptlet)**에 작성된 소스는 변환된 Servlet의 **`_jspService()` 메서드 안에 포함**
- JSP 스크립트 요소 중 **표현식(Expression)**은 변환된 Servlet의 `_jspService()` 메서드 안에서 **`out.print()` 으로 변환**
- JSP 스크립트 요소 중 **선언문(Declaration)**에 작성된 소스는 변환된 Servlet의 **멤버 메서드로 변환**
- JSP에 작성된 **HTML 태그**는 변환된 Servlet의 `_jspService()` 메서드 안에서 **`out.write()` 메서드로 변환**
- **page 디렉티브**는 JSP 엔진에게 페이지에 대한 지시를 제공하며, 이 지시는 JSP 엔진이 JSP 파일을 Servlet으로 변환할 때 참고됨
- 참조
  + [[JSP]스크립팅 요소](https://drj9812.github.io/posts/scripting-elements/){: target="_blank" }

### 예시

#### scriptlet.jsp

```html
<%@ page import="com.itwill.jsp1.model.Contact" %>
<%@ page import="java.util.ArrayList"%>
<%@ page language="java"
        contentType="text/html; charset=UTF-8"
        pageEncoding="UTF-8"
        trimDirectiveWhitespaces="true"%>
<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>JSP</title>
  </head>
  <body>
    <h1>JSP scriptlet 활용</h1>
    <%!
    public void startFor() {
        System.out.println("반복문이 시작됩니다. 이것은 HTML이 아닌 콘솔 출력");
    }
    %>
    <%
    ArrayList<Contact> data = new ArrayList<>();

    this.startFor();

    for (int i = 0; i < 10; i++) {
        Contact c = new Contact(i, "이름_" + i, "전화번호_" + i, "eamil_" + i);
        data.add(c);
    }
    %>
    <%=
    "데이터 리스트의 크기: " + data.size()
    %>
    <table>
      <caption>연락처</caption>
      <thead>
        <tr>
          <th>NO.</th>
          <th>이름</th>
          <th>전화번호</th>
          <th>이메일</th>
        </tr>
      </thead>
      <tbody>
        <%
        for (Contact c : data) {
        out.print("<tr>");
        out.print("<td>" + c.getId() + "</td>");
        out.print("<td>" + c.getName() + "</td>");
        out.print("<td>" + c.getPhone() + "</td>");
        out.print("<td>" + c.getEmail() + "</td>");
        out.print("</tr>");
        }
        %>
      </tbody>            
      </table>
  </body>
</html>
```
{: file="scriptlet.jsp" }

#### scriptlet_jsp.java

```java
/*
 * Generated by the Jasper component of Apache Tomcat
 * Version: Apache Tomcat/10.1.9
 * Generated at: 2024-06-12 08:48:09 UTC
 * Note: The last modified time of this file was set to
 *       the last modified time of the source file after
 *       generation to assist with modification tracking.
 */
package org.apache.jsp;

import jakarta.servlet.*;
import jakarta.servlet.http.*;
import jakarta.servlet.jsp.*;
import com.itwill.jsp1.model.Contact;
import java.util.ArrayList;

public final class scriptlet_jsp extends org.apache.jasper.runtime.HttpJspBase
                                 implements org.apache.jasper.runtime.JspSourceDependent,
                                            org.apache.jasper.runtime.JspSourceImports,
                                            org.apache.jasper.runtime.JspSourceDirectives {

    public void startFor() {
        System.out.println("반복문이 시작됩니다. 이것은 HTML이 아닌 콘솔 출력");
    }

    private static final jakarta.servlet.jsp.JspFactory _jspxFactory = jakarta.servlet.jsp.JspFactory.getDefaultFactory();

    private static java.util.Map<java.lang.String,java.lang.Long> _jspx_dependants;

    private static final java.util.Set<java.lang.String> _jspx_imports_packages;

    private static final java.util.Set<java.lang.String> _jspx_imports_classes;

    static {
        _jspx_imports_packages = new java.util.HashSet<>();
        _jspx_imports_packages.add("jakarta.servlet");
        _jspx_imports_packages.add("jakarta.servlet.http");
        _jspx_imports_packages.add("jakarta.servlet.jsp");
        _jspx_imports_classes = new java.util.HashSet<>();
        _jspx_imports_classes.add("com.itwill.jsp1.model.Contact");
        _jspx_imports_classes.add("java.util.ArrayList");
    }

    private volatile jakarta.el.ExpressionFactory _el_expressionfactory;
    private volatile org.apache.tomcat.InstanceManager _jsp_instancemanager;

    public java.util.Map<java.lang.String,java.lang.Long> getDependants() {
        return _jspx_dependants;
    }

    public java.util.Set<java.lang.String> getPackageImports() {
        return _jspx_imports_packages;
    }

    public java.util.Set<java.lang.String> getClassImports() {
        return _jspx_imports_classes;
    }

    public boolean getErrorOnELNotFound() {
        return false;
    }

    public jakarta.el.ExpressionFactory _jsp_getExpressionFactory() {
        if (_el_expressionfactory == null) {
            synchronized (this) {
                if (_el_expressionfactory == null) {
                    _el_expressionfactory = _jspxFactory.getJspApplicationContext(getServletConfig().getServletContext()).getExpressionFactory();
                }
            }
        }
        return _el_expressionfactory;
    }

    public org.apache.tomcat.InstanceManager _jsp_getInstanceManager() {
        if (_jsp_instancemanager == null) {
            synchronized (this) {
                if (_jsp_instancemanager == null) {
                    _jsp_instancemanager = org.apache.jasper.runtime.InstanceManagerFactory.getInstanceManager(getServletConfig());
                }
            }
        }
        return _jsp_instancemanager;
    }

    public void _jspInit() {}

    public void _jspDestroy() {}

    public void _jspService(final jakarta.servlet.http.HttpServletRequest request, final jakarta.servlet.http.HttpServletResponse response) throws java.io.IOException, jakarta.servlet.ServletException {

        if (!jakarta.servlet.DispatcherType.ERROR.equals(request.getDispatcherType())) {
            final java.lang.String _jspx_method = request.getMethod();
            if ("OPTIONS".equals(_jspx_method)) {
                response.setHeader("Allow","GET, HEAD, POST, OPTIONS");
                return;
            }
            if (!"GET".equals(_jspx_method) && !"POST".equals(_jspx_method) && !"HEAD".equals(_jspx_method)) {
                response.setHeader("Allow","GET, HEAD, POST, OPTIONS");
                response.sendError(HttpServletResponse.SC_METHOD_NOT_ALLOWED, "JSP들은 오직 GET, POST 또는 HEAD 메소드만을 허용합니다. Jasper는 OPTIONS 메소드 또한 허용합니다.");
                return;
            }
        }

        final jakarta.servlet.jsp.PageContext pageContext;
        jakarta.servlet.http.HttpSession session = null;
        final jakarta.servlet.ServletContext application;
        final jakarta.servlet.ServletConfig config;
        jakarta.servlet.jsp.JspWriter out = null;
        final java.lang.Object page = this;
        jakarta.servlet.jsp.JspWriter _jspx_out = null;
        jakarta.servlet.jsp.PageContext _jspx_page_context = null;


        try {
            response.setContentType("text/html; charset=UTF-8");
            pageContext = _jspxFactory.getPageContext(this, request, response, null, true, 8192, true);
            _jspx_page_context = pageContext;
            application = pageContext.getServletContext();
            config = pageContext.getServletConfig();
            session = pageContext.getSession();
            out = pageContext.getOut();
            _jspx_out = out;

            out.write("<!DOCTYPE html>\r\n");
            out.write("<html>\r\n");
            out.write("  <head>\r\n");
            out.write("    <meta charset=\"UTF-8\" />\r\n");
            out.write("    <title>JSP</title>\r\n");
            out.write("  </head>\r\n");
            out.write("  <body>\r\n");
            out.write("    <h1>JSP scriptlet 활용</h1>\r\n");
            out.write("    ");

            ArrayList<Contact> data = new ArrayList<>();

            this.startFor();

            for (int i = 0; i < 10; i++) {
                Contact c = new Contact(i, "이름_" + i, "전화번호_" + i, "eamil_" + i);
                data.add(c);
            }

            out.print( "데이터 리스트의 크기: " + data.size() );
            out.write("<table>\r\n");
            out.write("      <caption>연락처</caption>\r\n");
            out.write("      <thead>\r\n");
            out.write("        <tr>\r\n");
            out.write("          <th>NO.</th>\r\n");
            out.write("          <th>이름</th>\r\n");
            out.write("          <th>전화번호</th>\r\n");
            out.write("          <th>이메일</th>\r\n");
            out.write("        </tr>\r\n");
            out.write("      </thead>\r\n");
            out.write("      <tbody>\r\n");
            out.write("        ");

            for (Contact c : data) {
                out.print("<tr>");
                out.print("<td>" + c.getId() + "</td>");
                out.print("<td>" + c.getName() + "</td>");
                out.print("<td>" + c.getPhone() + "</td>");
                out.print("<td>" + c.getEmail() + "</td>");
                out.print("</tr>");
            }

            out.write("</tbody>            \r\n");
            out.write("      </table>\r\n");
            out.write("  </body>\r\n");
            out.write("</html>");
        } catch (java.lang.Throwable t) {
            if (!(t instanceof jakarta.servlet.jsp.SkipPageException)) {
                out = _jspx_out;
            if (out != null && out.getBufferSize() != 0)
                try {
                    if (response.isCommitted()) {
                    out.flush();
                    } else {
                      out.clearBuffer();
                   }
                } catch (java.io.IOException e) {}
                    if (_jspx_page_context != null) _jspx_page_context.handlePageException(t);
                    else throw new ServletException(t);
            }
        } finally {
            _jspxFactory.releasePageContext(_jspx_page_context);
        }
    }
}
```
{: file="scriptlet_jsp.java" }

- `public final class scriptlet_jsp extends org.apache.jasper.runtime.HttpJspBase`
  + `HttpJspBase` 클래스는 `HttpServlet` 클래스를 상속받음

##### 스크립트릿

```jsp
<%
ArrayList<Contact> data = new ArrayList<>();

his.startFor();

for (int i = 0; i < 10; i++) {
    Contact c = new Contact(i, "이름_" + i, "전화번호_" + i, "eamil_" + i);
    data.add(c);
}
%>
```
{: file="scriptlet.jsp" }

```java
public void _jspService(final jakarta.servlet.http.HttpServletRequest request,
                        final jakarta.servlet.http.HttpServletResponse response) throws java.io.IOException,
                                                                                        jakarta.servlet.ServletException {
    // ...

    try {
        ArrayList<Contact> data = new ArrayList<>();

        this.startFor();

        for (int i = 0; i < 10; i++) {
            Contact c = new Contact(i, "이름_" + i, "전화번호_" + i, "eamil_" + i);
            data.add(c);
        }
    }

    //...
}
```
{: file="scriptlet_jsp.java }

##### 표현식

```jsp
<%= "데이터 리스트의 크기: " + data.size() %>
```
{: file="scriptlet.jsp" }

```java
public void _jspService(final jakarta.servlet.http.HttpServletRequest request,
                        final jakarta.servlet.http.HttpServletResponse response) throws java.io.IOException,
                                                                                        jakarta.servlet.ServletException {
    // ...

    try {
        // ...
        out.print( "데이터 리스트의 크기: " + data.size() );
    }

    //...
}
```
{: file="scriptlet_jsp.java" }

##### 선언문

```jsp
<%!
public void startFor() {
    System.out.println("반복문이 시작됩니다. 이것은 HTML이 아닌 콘솔 출력");
}
%>
```
{: file="scriptlet.jsp" }

```java
public final class scriptlet_jsp extends org.apache.jasper.runtime.HttpJspBase
                                 implements org.apache.jasper.runtime.JspSourceDependent,
                                            org.apache.jasper.runtime.JspSourceImports,
                                            org.apache.jasper.runtime.JspSourceDirectives {

    public void startFor() {
        System.out.println("반복문이 시작됩니다. 이것은 HTML이 아닌 콘솔 출력");
    }
}
```

##### HTML 태그

```jsp
<!DOCTYPE html>
<html>
  <!-- ... -->
</html>
```
{: file="scriptlet.jsp" }

```java
public void _jspService(final jakarta.servlet.http.HttpServletRequest request,
                        final jakarta.servlet.http.HttpServletResponse response) throws java.io.IOException,
                                                                                        jakarta.servlet.ServletException {
    // ...

    try {
        // ...
        out.write("<!DOCTYPE html>\r\n");
        out.write("<html>\r\n");
        // ...
        out.write("</html>");
    }

    //...
}
```
{: file="scriptlet_jsp.java" }

##### page 디렉티브 태그

```jsp
<%@ page import="com.itwill.jsp1.model.Contact" %>
<%@ page import="java.util.ArrayList"%>
<%@ page language="java"
        contentType="text/html; charset=UTF-8"
        pageEncoding="UTF-8"
        trimDirectiveWhitespaces="true"%>
```
{: file="scriptlet.jsp" }

```java
import com.itwill.jsp1.model.Contact;
import java.util.ArrayList;
// ...

public final class scriptlet_jsp extends org.apache.jasper.runtime.HttpJspBase
                                 implements org.apache.jasper.runtime.JspSourceDependent,
                                            org.apache.jasper.runtime.JspSourceImports,
                                            org.apache.jasper.runtime.JspSourceDirectives {

    public void _jspService(final jakarta.servlet.http.HttpServletRequest request,
                            final jakarta.servlet.http.HttpServletResponse response) throws java.io.IOException,
                                                                                            jakarta.servlet.ServletException {
        // ...

        try {
            // ...
            response.setContentType("text/html; charset=UTF-8");
            // ...
        }

        //...
    }
}
```
{: file="scriptlet_jsp.java" }

## 컴파일

![class-file](/assets/img/posts/language/java/jsp/how-jsp-works/class-file.jpg)

- 변환된 `.java`{: .filepath }(Servlet)은 Java 컴파일러에 의해 컴파일되어 `.class`{: .filepath } 파일로 변환

## 로드 및 실행

- 컴파일된 Servlet 클래스 파일이 로드되고, 서블릿 컨테이너에 의해 인스턴스화됨
- Servlet의 `_jspInit()` 메서드가 호출되어 초기화 작업이 수행됨
- 클라이언트의 요청이 들어오면 서블릿의 `_jspService()` 메서드가 호출되고, 이 메소드 내에서 `doGet()`, `doPost()` 등의 메서드가 호출되어 요청을 처리
  + 응답

## 응답 및 전송

![result-jsp](/assets/img/posts/language/java/jsp/how-jsp-works/result-jsp.jpg)

- Servlet이 클라이언트 요청을 처리한 후, 결과를 생성하여 클라이언트에게 응답으로 전송
  + 응답은 HTML, JSON, XML 등 다양한 형식일 수 있음


## 참고자료

- [도로락, "[서블릿/JSP] JSP가 Servlet으로 변환되는 과정 및 규칙", 코끼리를 냉장고에 넣는 방법, 2018-02-07](https://dololak.tistory.com/138){: target="_blank" }
- [MangKyu, "[JSP] 서블릿(Servlet)이란?", 망나니개발자, 2017-11-04](https://mangkyu.tistory.com/14){: target="_blank" }